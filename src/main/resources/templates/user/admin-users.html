<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 사용자 목록</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title">관리자 - 사용자 목록</h1>
            <!-- 삭제 폼, REST API 호출로 사용자 삭제 -->
            <form id="delete-form" onsubmit="handleDelete(event)">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>ID</th>
                                <th>사용자 이름</th>
                                <th>이메일</th>
                                <th>역할</th>
                                <th>생성 시간</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
                <a href="/users" class="btn btn-secondary mb-3">사용자 목록으로 돌아가기</a>
                <button type="submit" class="btn btn-secondary mb-3">선택 삭제</button>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        console.log("admin-users.html: 스크립트 로드 시작");
        document.addEventListener('DOMContentLoaded', function () {
            console.log("admin-users.html: DOM 로드 완료");
            // 사용자 목록 조회 API 호출
            axios.get('/api/users', { withCredentials: true })
                .then(response => {
                    console.log("admin-users.html: 사용자 목록 조회 성공", response.data);
                    // API 응답에서 사용자 데이터 추출
                    const users = response.data.data;
                    const tbody = document.getElementById('user-list');
                    // 사용자 목록을 동적으로 테이블에 렌더링
                    users.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="vertical-align: middle;"><input type="checkbox" name="ids" value="${user.id}"></td>
                            <td style="vertical-align: middle;">${user.id}</td>
                            <td style="vertical-align: middle;">${user.username}</td>
                            <td style="vertical-align: middle;">${user.email}</td>
                            <td style="vertical-align: middle;">${user.role === 'USER' ? '일반 사용자' : '관리자'}</td>
                            <td style="vertical-align: middle;">${new Date(user.createdDttm).toLocaleString('ko-KR')}</td>
                            <td style="vertical-align: middle;">
                                <a href="/api/users/${user.id}" class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; line-height: 1;" onclick="deleteUser(${user.id}, event)">X</a>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // 전체 선택 체크박스
                    document.getElementById('selectAll').addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="ids"]');
                        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                    });
                })
                .catch(error => {
                    console.error("admin-users.html: 사용자 목록 조회 실패", error);
                    alert(error.response?.data?.message || "사용자 목록 조회 중 오류가 발생했습니다.");
                });

            // 메시지 및 에러 표시
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            const error = urlParams.get('error');
            if (message) {
                alert(decodeURIComponent(message));
            } else if (error) {
                alert(decodeURIComponent(error));
            }
        });

        // 다중 사용자 삭제 처리
        function handleDelete(event) {
            event.preventDefault();
            console.log("admin-users.html: 삭제 요청 시작");
            // 선택된 체크박스 ID 수집
            const checkboxes = document.querySelectorAll('input[name="ids"]:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (ids.length === 0) {
                console.warn("admin-users.html: 삭제할 사용자 선택 안됨");
                alert("삭제할 사용자를 선택하세요.");
                return;
            }
            // 삭제 API 호출
            axios.delete('/api/users', { data: { ids }, withCredentials: true })
                .then(response => {
                    console.log("admin-users.html: 삭제 성공", response.data);
                    window.location.href = '/admin/users?message=' + encodeURIComponent('선택한 사용자가 삭제되었습니다.');
                })
                .catch(error => {
                    console.error("admin-users.html: 삭제 실패", error);
                    alert(error.response?.data?.message || "사용자 삭제 중 오류가 발생했습니다.");
                });
        }

        // 개별 사용자 삭제 처리
        function deleteUser(id, event) {
            event.preventDefault();
            console.log("admin-users.html: 개별 삭제 요청 시작, id=" + id);
            // 개별 삭제 API 호출
            axios.delete('/api/users/' + id, { withCredentials: true })
                .then(response => {
                    console.log("admin-users.html: 개별 삭제 성공", response.data);
                    window.location.href = '/admin/users?message=' + encodeURIComponent('사용자가 삭제되었습니다.');
                })
                .catch(error => {
                    console.error("admin-users.html: 개별 삭제 실패", error);
                    alert(error.response?.data?.message || "사용자 삭제 중 오류가 발생했습니다.");
                });
        }
    </script>
</section>
</html>