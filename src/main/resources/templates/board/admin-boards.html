<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 게시글 목록</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title">관리자 - 게시글 목록</h1>
            <!-- 삭제 폼, REST API 호출로 게시글 삭제 -->
            <form id="delete-form" onsubmit="handleDelete(event)">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>ID</th>
                                <th>제목</th>
                                <th>작성자</th>
                                <th>생성 시간</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="board-list"></tbody>
                    </table>
                </div>
                <a href="/boards" class="btn btn-secondary mb-3">게시판 목록으로 돌아가기</a>
                <button type="submit" class="btn btn-secondary mb-3">선택 삭제</button>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        console.log("admin-boards.html: 스크립트 로드 시작");
        document.addEventListener('DOMContentLoaded', function () {
            console.log("admin-boards.html: DOM 로드 완료");
            // 게시글 목록 조회 API 호출
            axios.get('/api/boards', { withCredentials: true })
                .then(response => {
                    console.log("admin-boards.html: 게시글 목록 조회 성공", response.data);
                    // API 응답에서 게시글 데이터 추출
                    const boards = response.data.data;
                    const tbody = document.getElementById('board-list');
                    // 게시글 목록을 동적으로 테이블에 렌더링
                    boards.forEach(board => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="vertical-align: middle;"><input type="checkbox" name="ids" value="${board.id}"></td>
                            <td style="vertical-align: middle;">${board.id}</td>
                            <td style="vertical-align: middle;">${board.title}</td>
                            <td style="vertical-align: middle;">${board.author}</td>
                            <td style="vertical-align: middle;">${new Date(board.createdDttm).toLocaleString('ko-KR')}</td>
                            <td style="vertical-align: middle;">
                                <a href="#" class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; line-height: 1;" onclick="deleteBoard(${board.id}, event)">X</a>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // 전체 선택 체크박스 이벤트
                    document.getElementById('selectAll').addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="ids"]');
                        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                    });
                })
                .catch(error => {
                    console.error("admin-boards.html: 게시글 목록 조회 실패", error);
                    alert(error.response?.data?.message || "게시글 목록 조회 중 오류가 발생했습니다.");
                });

            // 메시지 및 에러 표시
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            const error = urlParams.get('error');
            if (message) {
                alert(decodeURIComponent(message));
            } else if (error) {
                alert(decodeURIComponent(error));
            }
        });

        // 다중 게시글 삭제 처리
        function handleDelete(event) {
            event.preventDefault();
            console.log("admin-boards.html: 다중 삭제 요청 시작");
            // 선택된 체크박스 ID 수집
            const checkboxes = document.querySelectorAll('input[name="ids"]:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (ids.length === 0) {
                console.warn("admin-boards.html: 삭제할 게시글 선택 안됨");
                alert("삭제할 게시글을 선택하세요.");
                return;
            }
            // 삭제 API 호출
            axios.delete('/api/boards', { data: { ids }, withCredentials: true })
                .then(response => {
                    console.log("admin-boards.html: 다중 삭제 성공", response.data);
                    window.location.href = '/admin/boards?message=' + encodeURIComponent('선택한 게시글이 삭제되었습니다.');
                })
                .catch(error => {
                    console.error("admin-boards.html: 다중 삭제 실패", error);
                    alert(error.response?.data?.message || "게시글 삭제 중 오류가 발생했습니다.");
                });
        }

        // 단일 게시글 삭제 처리
        function deleteBoard(id, event) {
            event.preventDefault();
            console.log("admin-boards.html: 단일 삭제 요청 시작, id=" + id);
            // 단일 삭제 API 호출
            axios.delete('/api/boards/' + id, { withCredentials: true })
                .then(response => {
                    console.log("admin-boards.html: 단일 삭제 성공", response.data);
                    window.location.href = '/admin/boards?message=' + encodeURIComponent('게시글이 삭제되었습니다.');
                })
                .catch(error => {
                    console.error("admin-boards.html: 단일 삭제 실패", error);
                    alert(error.response?.data?.message || "게시글 삭제 중 오류가 발생했습니다.");
                });
        }
    </script>
</section>
</html>